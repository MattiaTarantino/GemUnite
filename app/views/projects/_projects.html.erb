<div id="projects">
  <% current_user_fields = current_user.fields.pluck(:nome) %>
  <% project_ids_user_is_member = UserProject.where(user_id: current_user.id).pluck(:project_id) %>

  <% projects_with_common_fields = @projects.select do |project|
    (project.fields.pluck(:nome) & current_user_fields).any?
  end %>

  <% projects_not_member = projects_with_common_fields.reject do |project|
    project_ids_user_is_member.include?(project.id)
  end %>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Nome</th>
        <th>Descrizione</th>
      </tr>
      </thead>
      <tbody>
      <% if projects_not_member.empty? %>
        <tr>
          <td colspan="2">
            Non ci sono progetti aperti che corrispondono ai tuoi interessi.
            <%= link_to "Aggiungi nuovi ambiti d'interesse", edit_user_registration_path %>
          </td>
        </tr>
      <% else %>
        <% projects_not_member.each do |project| %>
          <% members = UserProject.where(project_id: project.id).count %>
          <% if project.stato == "aperto" and project.dimensione > members %>
            <tr>
              <td><%= project.name %></td>
              <td><%= project.descrizione %></td>
              <td>Numero membri: <%= members %></td>
              <td>Ambito:
                <% project.fields.each do |field| %>
                  <%= field.nome %>
                <% end %>
              </td>
              <td>Leader:
                <% project.user_projects.each do |user_project| %>
                  <% if user_project.role == "leader" %>
                    <%= user_project.user.username %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <%= link_to "Mostra questo progetto", project, class: "btn btn-primary" %>
              </td>
            </tr>
          <% end %>
        <% end %>
      <% end %>
      </tbody>
    </table>
  </div>
</div>
